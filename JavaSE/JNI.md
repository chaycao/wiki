# JNI

## 概念

JNI（Java Native Interface）

是Java平台的一部分，可以实现与其他语言（如C、C++）进行交互

JNI 是完善 Java 功能的一个重要功能：

JVM 封装了各种操作系统的差异性，可使得 Java 程序跨平台

JNI 提供了 Java 程序与操作系统相关功能函数交互的接口

## 应用场景

程序对时间敏感或对性能要求特别高，有必要用更底层的语言（如汇编、C、C++）

在已有现成的用其他语言已完成的功能时，需要用 Java 去调用

在需要用到 Java 标准平台不具备的依赖于操作系统的特性时

## 原理

调用过程示例图

![JNI原理](/images/JNI原理.png)

## 使用步骤

在 Java 类中声明 Native 方法，类中同时需要加载使用的动态库

用 javah 程序，将上步中的 class 文件生成头文件

```bash
javah -jni XXX
```

javah 程序统一了 Java 中的 native 方法、头文件中的函数名和动态库中的函数实现之间的对应关系

用其他语言（如C、C++）实现上述头文件中的函数，生成动态库，供 Java 程序使用

发布 Java 和动态库

## 实例

环境：Ubuntu 10.4.2 LTS系统

```java
 package com.magc.jni;

 public class HelloWorld {
    
    static {
        System.loadLibrary("Hello");
    }

    public native void DisplayHello();

    public static void main(String[] args) {
        new HelloWorld().DisplayHello();
    }

}
```


进入src目录下，编译该JAVA类，

```bash
javac ./com/magc/jni/HelloWorld.java
```

在该HelloWorld.java所在目录下生成HelloWorld.class

然后使用javah生成头文件，

```bash
javah -jni com.magc.jni.HelloWorld
```

在当前目录下生成com_magc_jni_HelloWorld.h头文件，此文件供C、C++程序来引用并实现其中的函数

```c++
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
 /* Header for class com_magc_jni_HelloWorld */

#ifndef _Included_com_magc_jni_HelloWorld
#define _Included_com_magc_jni_HelloWorld
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     com_magc_jni_HelloWorld
 * Method:    DisplayHello
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_com_magc_jni_HelloWorld_DisplayHello
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

注：1)、此头文件是不需要用户编译的，直接供其它C、C++程序引用。    

 2)、此头文件中的Java_com_magc_jni_HelloWorld_DisplayHello(JNIEnv *, jobject)方法，是将来与动态链接库交互的接口，并需要名字保持一致。

```c++
#include <jni.h>
#include "com_magc_jni_HelloWorld.h"
#include <stdio.h>
JNIEXPORT void JNICALL Java_com_magc_jni_HelloWorld_DisplayHello
(JNIEnv *env, jobject obj)
{
    printf("From jni_helloworldImpl.cpp :");
    printf("Hello world ! \n");
    return;
}
```

此C++文件实现了上述头文件中的函数，注意方法函数名要保持一致。

编译生成动态库 libHello.so

```bash
g++ -shared -I /usr/lib/jvm/java-6-openjdk/include jni_helloworldImpl.cpp -o libHello.so
```

成功后，便会在当前目录下生成动态链接库libHello.so文件。

有了具体实现的动态库后，就可以运行 JAVA 调用 JNI程序类的 native 方法了。

```bash
java -Djava.library.path=. com.magc.jni.HelloWorld
```